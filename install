#!/usr/bin/env zsh
set -euo pipefail

DOTFILES_DIR="$HOME/dotfiles"
DRY_RUN=false

# Parse arguments
for arg in "$@"; do
  case "$arg" in
    --dry-run)
      DRY_RUN=true
      shift
      ;;
    *)
      echo "Unknown option: $arg"
      exit 1
      ;;
  esac
done

function link() {
  src="$1"
  dest="$2"

  if [ "$DRY_RUN" = true ]; then
    echo "[DRY RUN] Would link: $src ‚Üí $dest"
  else
    mkdir -p "$(dirname "$dest")"
    ln -sf "$src" "$dest"
    echo "Linked: $src ‚Üí $dest"
  fi
}

echo "Symlinking dotfiles..."
export XDG_CONFIG_HOME="$HOME/.config"

link "$DOTFILES_DIR/.gitconfig" "$HOME/.gitconfig"
link "$DOTFILES_DIR/config/.codex" "$HOME/.codex"
link "$DOTFILES_DIR/config/bat" "$XDG_CONFIG_HOME/bat"
link "$DOTFILES_DIR/config/hammerspoon" "$XDG_CONFIG_HOME/hammerspoon"
link "$DOTFILES_DIR/config/lazygit" "$XDG_CONFIG_HOME/lazygit"
link "$DOTFILES_DIR/config/ncspot" "$XDG_CONFIG_HOME/ncspot"
link "$DOTFILES_DIR/config/nvim" "$XDG_CONFIG_HOME/nvim"
link "$DOTFILES_DIR/config/wezterm" "$XDG_CONFIG_HOME/wezterm"
link "$DOTFILES_DIR/config/zed" "$XDG_CONFIG_HOME/zed"
link "$DOTFILES_DIR/config/atuin" "$XDG_CONFIG_HOME/atuin"
link "$DOTFILES_DIR/config/mcphub" "$XDG_CONFIG_HOME/mcphub"

echo "Done symlinking!"


echo "Initialize ZSH environment..."

export ZDOTDIR="$XDG_CONFIG_HOME/zsh"

# change the root .zshenv file to use ZDOTDIR
cat << EOF >| $HOME/.zshenv
# This file is generated during install. Make changes to ${0:a:h}
export ZDOTDIR=$ZDOTDIR
[[ -f \$ZDOTDIR/.zshenv ]] && . \$ZDOTDIR/.zshenv
EOF

link "$DOTFILES_DIR/config/zsh" $ZDOTDIR

setopt EXTENDED_GLOB
for rcfile in "${ZDOTDIR:-$HOME}"/.zprezto/runcoms/^README.md(.N); do
  link "$rcfile" "${ZDOTDIR:-$HOME}/.${rcfile:t}"
done

echo "Done initializing ZSH environment!"

echo "Miscellaneous configurations..."

# TODO: Integrate with dry run
defaults write org.hammerspoon.Hammerspoon MJConfigFile "~/.config/hammerspoon/init.lua"

echo "Done with miscellaneous configurations!"

# TODO: Copy secret-vars

echo "üîç Checking for Homebrew..."

if command -v brew >/dev/null 2>&1; then
  echo "‚úÖ Homebrew is already installed."
else
  echo "üç∫ Installing Homebrew..."

  NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  echo "‚úÖ Homebrew installation complete."
fi

echo "üçª Homebrew is ready!"

echo "Installing Homebrew packages..."

xargs brew install < Brewfile-formulae.txt
xargs brew install --cask < Brewfile-casks.txt

echo "Done installing Homebrew packages!"

echo "Install miscellaneous packages..."

gh extension install github/gh-copilot

echo "Done installing miscellaneous packages!"

echo "Done with installation!"
